<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订阅服务管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .container {
            max-width: 960px;
            margin-top: 40px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #343a40;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-primary {
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-primary:hover {
            background-color: #23272b;
            border-color: #23272b;
        }
        .subscriptions-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .form-control:focus {
            border-color: #343a40;
            box-shadow: 0 0 0 0.25rem rgba(52, 58, 64, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">订阅服务管理系统</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">订阅源管理</h5>
                    </div>
                    <div class="card-body">
                        <form id="addSubscriptionForm">
                            <div class="mb-3">
                                <label for="subName" class="form-label">名称</label>
                                <input type="text" class="form-control" id="subName" required>
                            </div>
                            <div class="mb-3">
                                <label for="subUrl" class="form-label">URL</label>
                                <input type="url" class="form-control" id="subUrl" required>
                            </div>
                            <div class="mb-3">
                                <label for="accessToken" class="form-label">访问令牌</label>
                                <input type="password" class="form-control" id="accessToken" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">添加订阅</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">订阅列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="listAccessToken" class="form-label">访问令牌</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="listAccessToken">
                                <button class="btn btn-primary" id="loadSubscriptionsBtn">加载列表</button>
                            </div>
                        </div>
                        <div class="subscriptions-list mt-3" id="subscriptionsList">
                            <div class="text-center text-muted">
                                请输入访问令牌并点击加载列表
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">订阅链接</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="linkToken" class="form-label">访问令牌</label>
                    <input type="password" class="form-control" id="linkToken">
                </div>
                <div class="mb-3">
                    <label class="form-label">客户端订阅链接</label>
                    <div class="list-group" id="subscriptionLinks">
                        <div class="list-group-item">请输入访问令牌</div>
                    </div>
                </div>
                <button class="btn btn-primary" id="generateLinksBtn">生成链接</button>
            </div>
        </div>
    </div>

    <!-- 成功提示模态框 -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">操作成功</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="successMessage">
                    操作已成功完成。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错误提示模态框 -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">错误</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorMessage">
                    操作过程中发生错误。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 加载订阅列表
        document.getElementById('loadSubscriptionsBtn').addEventListener('click', function() {
            const token = document.getElementById('listAccessToken').value;
            if (!token) {
                showError('请输入访问令牌');
                return;
            }

            fetch(`/api/list?token=${token}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取订阅列表失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const listElement = document.getElementById('subscriptionsList');
                        if (data.subscriptions.length === 0) {
                            listElement.innerHTML = '<div class="text-center text-muted">暂无订阅</div>';
                            return;
                        }

                        listElement.innerHTML = '';
                        data.subscriptions.forEach((sub, index) => {
                            const item = document.createElement('div');
                            item.className = 'card mb-2';
                            item.innerHTML = `
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">${sub.name}</h6>
                                            <small class="text-muted">${sub.url}</small>
                                        </div>
                                        <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">删除</button>
                                    </div>
                                </div>
                            `;
                            listElement.appendChild(item);
                        });

                        // 添加删除事件
                        document.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const index = this.getAttribute('data-index');
                                deleteSubscription(index, token);
                            });
                        });
                    } else {
                        showError(data.error || '获取订阅列表失败');
                    }
                })
                .catch(error => {
                    showError(error.message);
                });
        });

        // 添加订阅
        document.getElementById('addSubscriptionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('subName').value;
            const url = document.getElementById('subUrl').value;
            const token = document.getElementById('accessToken').value;

            if (!name || !url || !token) {
                showError('请填写所有必填字段');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('url', url);
            formData.append('token', token);

            fetch('/api/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('订阅添加成功');
                    document.getElementById('subName').value = '';
                    document.getElementById('subUrl').value = '';
                    
                    // 如果列表令牌已填写，刷新列表
                    const listToken = document.getElementById('listAccessToken').value;
                    if (listToken) {
                        document.getElementById('loadSubscriptionsBtn').click();
                    }
                } else {
                    showError(data.error || '添加订阅失败');
                }
            })
            .catch(error => {
                showError('请求失败: ' + error.message);
            });
        });

        // 删除订阅
        function deleteSubscription(index, token) {
            if (!confirm('确定要删除此订阅吗？')) {
                return;
            }

            const formData = new FormData();
            formData.append('index', index);
            formData.append('token', token);

            fetch('/api/delete', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('订阅删除成功');
                    // 刷新列表
                    document.getElementById('loadSubscriptionsBtn').click();
                } else {
                    showError(data.error || '删除订阅失败');
                }
            })
            .catch(error => {
                showError('请求失败: ' + error.message);
            });
        }

        // 生成订阅链接
        document.getElementById('generateLinksBtn').addEventListener('click', function() {
            const token = document.getElementById('linkToken').value;
            if (!token) {
                showError('请输入访问令牌');
                return;
            }

            const linksElement = document.getElementById('subscriptionLinks');
            linksElement.innerHTML = '';

            // 获取当前域名和端口
            const domain = window.location.hostname;
            const port = window.location.port ? `:${window.location.port}` : '';
            const baseUrl = `${window.location.protocol}//${domain}${port}/sub?token=${token}`;

            const clients = [
                { name: 'V2Ray/XRay', target: 'v2ray' },
                { name: 'Clash', target: 'clash' },
                { name: 'Shadowrocket', target: 'shadowrocket' },
                { name: 'Surge', target: 'surge' },
                { name: 'Quantumult X', target: 'quanx' }
            ];

            clients.forEach(client => {
                const link = `${baseUrl}&target=${client.target}`;
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${client.name}</strong>
                            <div class="text-break">
                                <small>${link}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-dark copy-btn" data-link="${link}">复制</button>
                    </div>
                `;
                linksElement.appendChild(item);
            });

            // 添加复制功能
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const link = this.getAttribute('data-link');
                    navigator.clipboard.writeText(link).then(() => {
                        this.textContent = '已复制';
                        setTimeout(() => {
                            this.textContent = '复制';
                        }, 2000);
                    }).catch(err => {
                        showError('复制失败: ' + err);
                    });
                });
            });
        });

        // 显示成功提示
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }

        // 显示错误提示
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }
    </script>
</body>
</html>